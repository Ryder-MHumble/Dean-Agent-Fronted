{
  "permissions": {
    "allow": [
      "Bash(test:*)",
      "Bash(pnpm --version:*)",
      "Bash(npm --version:*)",
      "Bash(npm install:*)",
      "Bash(npm run dev:*)",
      "Bash(tasklist:*)",
      "Bash(taskkill //F //PID 168672)",
      "WebFetch(domain:medium.com)",
      "WebFetch(domain:github.com)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git push:*)",
      "Bash(cmdkey /list:*)",
      "Bash(timeout:*)",
      "Bash(npx next build:*)",
      "Bash(if exist \".next\" rmdir /s /q \".next\")",
      "Bash(next dev)",
      "Bash(npm run build:*)",
      "Bash(npx tsc:*)",
      "Bash(npx next lint)",
      "Bash(npm run lint)",
      "Bash(taskkill:*)",
      "Bash(cmd /c \"taskkill /PID 38236 /F\")",
      "Bash(cmd /c \"taskkill /PID 38236 /F /T\")",
      "Bash(cmd /c \"netstat -ano | findstr :3000\")",
      "Bash(cmd /c \"del /f /q C:\\\\Users\\\\hp\\\\Desktop\\\\DeanAgent\\\\DeanAgent\\\\.next\\\\dev\\\\lock\")",
      "Bash(cmd /c \"del /f C:\\\\Users\\\\hp\\\\Desktop\\\\DeanAgent\\\\DeanAgent\\\\.next\\\\dev\\\\lock 2>nul\")",
      "Bash(cmd /c \"tasklist | findstr node.exe\")",
      "Bash(cmd /c \"if exist .next\\\\dev rmdir /s /q .next\\\\dev\")",
      "Bash(powershell -Command:*)",
      "Bash(cmd /c \"if exist .next rmdir /s /q .next\")",
      "Bash(if exist .next rmdir /s /q .next)",
      "Bash(find:*)",
      "Bash(wc:*)",
      "Bash(python3 -c \"\nimport os\ncontent = open\\(''/dev/stdin''\\).read\\(\\)\nos.makedirs\\(os.path.dirname\\(''/Users/sunminghao/.claude/plans/polished-baking-metcalfe.md''\\), exist_ok=True\\)\nwith open\\(''/Users/sunminghao/.claude/plans/polished-baking-metcalfe.md'', ''w''\\) as f:\n    f.write\\(content\\)\nprint\\(''Plan file written successfully''\\)\n\" << 'PYEOF'\n# 信息架构重构计划\n\n## Context\n\n当前系统将多个维度的信息混杂在同一页面（如\"战略雷达\"同时包含政策、技术、竞对三个维度），违反了信息架构设计方案中的\"信息纯净度\"原则。需要将系统从 5 个混合导航项重构为 8 个模块、27 个子页面，每个子页面只处理单一信息维度。\n\n---\n\n## 当前问题 vs 目标状态\n\n| 当前页面 | 问题 | 目标拆分 |\n|---------|------|---------|\n| 战略雷达 \\(intelligence.tsx, 1030行\\) | 政策+技术+竞对 混在3个tab里 | 拆到 政策情报、科技前沿、高校生态 三个独立模块 |\n| 院内事务 \\(operations.tsx, 777行\\) | 财务+项目+学生+舆情+中心 混在一页 | 拆为 院内管理 下5个独立子页面 |\n| 政策与人脉 \\(policy.tsx\\) | 政策追踪+人脉情报+社交行动 混在3个tab | 政策归入政策情报，人脉归入人脉网络 |\n| 院长早报 \\(home-briefing.tsx\\) | 基本符合，需更新指标卡为8个模块 | 微调 |\n| 智能日程 \\(schedule.tsx, 1303行\\) | 功能齐全但单体过大 | 拆为4个子页面 |\n\n---\n\n## 新导航结构（8模块）\n\n侧边栏各组之间用分割线隔开，收起模式只显示图标。\n\n**决策入口**\n1. 院长早报 \\(LayoutDashboard\\)\n\n**外部情报**\n2. 政策情报 \\(FileText\\) - 4个子页: 国家政策/北京政策/领导讲话/政策机会匹配\n3. 科技前沿 \\(Cpu\\) - 4个子页: 技术趋势/行业动态/热点与KOL/内参机会\n4. 人才雷达 \\(Globe\\) - 3个子页: 回流追踪/人才指数/学术人才流动\n5. 高校生态 \\(GraduationCap\\) - 3个子页: 同行动态/科研成果/人事动向\n\n**内部管理**\n6. 院内管理 \\(Building\\) - 5个子页: 财务管理/项目督办/学生事务/舆情安全/中心绩效\n\n**行动与日程**\n7. 人脉网络 \\(Users\\) - 3个子页: 人事变动/关系维护/社交行动\n8. 智能日程 \\(Calendar\\) - 4个子页: 日程总览/邀约评估/活动推荐/冲突化解\n\n---\n\n## 子页面导航模式\n\n每个模块内部使用水平Tab导航，位于 TopBar 下方。新建 ModuleLayout 通用组件封装此模式：\n\n```\nTopBar: \"政策情报\" / \"外部政策追踪与机会匹配\"\n[国家政策]  [北京政策]  [领导讲话]  [政策机会匹配]\n<子页面内容区>\n```\n\n院长早报（首页）不使用 ModuleLayout，直接渲染内容。\n\n---\n\n## 新文件结构\n\n```\ncomponents/\n  app-shell.tsx                    # 修改: 8个导航项+分组分割线\n  module-layout.tsx                # 新建: 通用模块Tab布局组件\n  floating-ai-assistant.tsx        # 不变\n  ai-secretary-sidebar.tsx         # 不变\n  motion/index.tsx                 # 不变\n\n  shared/                          # 新建: 跨模块共享组件\n    ai-insight-panel.tsx           # 提取: 暗色AI分析面板\n    kpi-card.tsx                   # 提取: 通用KPI指标卡\n    report-generator.tsx           # 移动自 radar/\n    approval-tasks.tsx             # 提取自 operations.tsx\n\n  modules/                         # 新建: 8大模块\n    home/                          # 模块1: 院长早报\n      index.tsx                    # 重构自 pages/home-briefing.tsx\n      must-know-alerts.tsx         # 移动自 home/\n      ai-daily-summary.tsx         # 移动自 home/\n      safety-index-gauge.tsx       # 移动自 home/\n      aggregated-metric-cards.tsx  # 重构: 4卡变8卡\n      timeline-view.tsx            # 移动自 home/\n\n    policy-intel/                  # 模块2: 政策情报\n      index.tsx\n      national-policy.tsx          # 提取自 policy-tracking-view \\(level=national\\)\n      beijing-policy.tsx           # 提取自 policy-tracking-view \\(level=beijing\\)\n      leadership-speeches.tsx      # 新建\n      policy-matching.tsx          # 合并: PolicyTab + policy-opportunity-pool\n\n    tech-frontier/                 # 模块3: 科技前沿\n      index.tsx\n      tech-trends.tsx              # 合并: TechTab + technology-trends\n      industry-dynamics.tsx        # 新建\n      hot-topics-kol.tsx           # 重构自 signal-feed.tsx\n      memo-opportunities.tsx       # 新建\n\n    talent-radar/                  # 模块4: 人才雷达\n      index.tsx\n      return-tracking.tsx          # 重构自 radar/talent-radar.tsx\n      talent-index.tsx             # 新建\n      academic-mobility.tsx        # 新建\n\n    university-eco/                # 模块5: 高校生态\n      index.tsx\n      peer-dynamics.tsx            # 重构自 CompetitorTab \\(改名为同行\\)\n      research-tracking.tsx        # 新建\n      personnel-talent.tsx         # 新建\n\n    internal-mgmt/                 # 模块6: 院内管理（严格5页分离）\n      index.tsx\n      finance.tsx                  # 提取 operations.tsx 预算相关 + 扩展\n      project-supervision.tsx      # 合并 ProjectTimeline + ProjectInfoTable\n      student-affairs.tsx          # 提取 operations.tsx 学生KPI + 扩展\n      sentiment-safety.tsx         # 提取 operations.tsx SentimentCenter\n      center-performance.tsx       # 提取 operations.tsx CenterPerformance\n\n    network/                       # 模块7: 人脉网络\n      index.tsx\n      personnel-changes.tsx        # 提取自 network-intelligence-view \\(人事部分\\)\n      relationship-mgmt.tsx        # 提取自 network-intelligence-view \\(CRM部分\\)\n      social-actions.tsx           # 移动自 policy/social-actions-view.tsx\n\n    smart-schedule/                # 模块8: 智能日程\n      index.tsx\n      schedule-overview.tsx        # 提取 schedule.tsx 日历+详情+AI顾问\n      invitation-eval.tsx          # 新建: 扩展自ROI评分逻辑\n      activity-recommend.tsx       # 提取 schedule.tsx 活动推荐\n      conflict-resolver.tsx        # 新建: 扩展自冲突检测逻辑\n\n  pages/                           # 废弃: 全部由 modules/ 替代\n  home/                            # 废弃: 移至 modules/home/\n  radar/                           # 废弃: 分配至各模块\n  policy/                          # 废弃: 分配至各模块\n  ui/                              # 不变\n```\n\n---\n\n## 组件迁移映射\n\n| 现有文件 | 处理 | 新位置 |\n|---------|------|-------|\n| intelligence.tsx PolicyTab \\(~225行\\) | 提取 | modules/policy-intel/policy-matching.tsx |\n| intelligence.tsx TechTab \\(~209行\\) | 提取 | modules/tech-frontier/tech-trends.tsx |\n| intelligence.tsx CompetitorTab \\(~185行\\) | 提取+改名 | modules/university-eco/peer-dynamics.tsx |\n| radar/policy-opportunity-pool.tsx | 合并入 | modules/policy-intel/policy-matching.tsx |\n| radar/technology-trends.tsx | 合并入 | modules/tech-frontier/tech-trends.tsx |\n| radar/competitor-monitoring.tsx | 合并入 | modules/university-eco/peer-dynamics.tsx |\n| radar/talent-radar.tsx | 移动+重构 | modules/talent-radar/return-tracking.tsx |\n| radar/signal-feed.tsx | 移动+重构 | modules/tech-frontier/hot-topics-kol.tsx |\n| radar/report-generator.tsx | 移至共享 | shared/report-generator.tsx |\n| operations.tsx SentimentCenter | 提取 | modules/internal-mgmt/sentiment-safety.tsx |\n| operations.tsx ProjectTimeline+Table | 合并 | modules/internal-mgmt/project-supervision.tsx |\n| operations.tsx CenterPerformance | 提取 | modules/internal-mgmt/center-performance.tsx |\n| operations.tsx ApprovalTasks | 提取为共享 | shared/approval-tasks.tsx |\n| policy/policy-tracking-view.tsx | 参数化拆分 | national-policy.tsx + beijing-policy.tsx |\n| policy/network-intelligence-view.tsx | 拆分 | personnel-changes.tsx + relationship-mgmt.tsx |\n| policy/social-actions-view.tsx | 直接移动 | modules/network/social-actions.tsx |\n| schedule.tsx 日历+详情 | 提取 | modules/smart-schedule/schedule-overview.tsx |\n| schedule.tsx 活动推荐 | 提取 | modules/smart-schedule/activity-recommend.tsx |\n| pages/dashboard.tsx | 删除 | 被 home-briefing 替代 |\n\n---\n\n## 实施阶段\n\n### Phase 1: 基础设施\n\n1. 创建 `components/module-layout.tsx` — 通用模块Tab布局组件\n2. 创建 `components/shared/` — 提取共享组件 \\(ai-insight-panel, kpi-card\\)\n3. 修改 `components/app-shell.tsx` — 导航从5项改为8项+分组分割线\n4. 修改 `app/page.tsx` — 路由从5页改为8页，更新 pageMeta\n\n关键文件: app-shell.tsx \\(L26-L32 navItems\\), page.tsx \\(L14-L59\\)\n\n### Phase 2: 核心模块提取\n\n**2a. 院内管理** — 拆 operations.tsx 为5个独立子页面\n- 创建 modules/internal-mgmt/index.tsx \\(5个tab\\)\n- 提取 SentimentCenter -> sentiment-safety.tsx\n- 合并 ProjectTimeline + ProjectInfoTable -> project-supervision.tsx\n- 提取 CenterPerformance -> center-performance.tsx\n- 新建 finance.tsx \\(预算执行+财务风险\\)\n- 新建 student-affairs.tsx \\(学生数据+心理预警\\)\n\n关键文件: operations.tsx\n\n**2b. 政策情报 + 人脉网络** — 拆 policy 体系\n- 参数化 policy-tracking-view.tsx -> national-policy.tsx + beijing-policy.tsx\n- 提取 PolicyTab -> policy-matching.tsx\n- 新建 leadership-speeches.tsx\n- 拆分 network-intelligence-view.tsx -> personnel-changes.tsx + relationship-mgmt.tsx\n- 移动 social-actions-view.tsx -> social-actions.tsx\n\n关键文件: policy-tracking-view.tsx, network-intelligence-view.tsx\n\n**2c. 科技前沿 + 高校生态** — 拆 intelligence.tsx\n- 提取 TechTab -> tech-trends.tsx\n- 提取 CompetitorTab -> peer-dynamics.tsx \\(改名竞对为同行\\)\n- 移动 signal-feed.tsx -> hot-topics-kol.tsx\n- 新建 industry-dynamics.tsx, memo-opportunities.tsx\n\n关键文件: intelligence.tsx\n\n**2d. 人才雷达 + 智能日程**\n- 移动 talent-radar.tsx -> return-tracking.tsx\n- 新建 talent-index.tsx, academic-mobility.tsx\n- 拆分 schedule.tsx -> 4个子页面\n\n关键文件: schedule.tsx, radar/talent-radar.tsx\n\n### Phase 3: 首页更新 + 清理\n\n- 更新 aggregated-metric-cards 从4卡变为8卡\n- 更新 home-briefing onNavigate 回调\n- 删除废弃文件和旧目录\n\n---\n\n## 需要全新开发的子页面\n\n| 子页面 | 模块 | 复用的UI模式 |\n|-------|------|------------|\n| leadership-speeches.tsx | 政策情报 | 复用 policy-tracking-view 列表+详情 |\n| industry-dynamics.tsx | 科技前沿 | 复用 signal-feed 卡片流 |\n| memo-opportunities.tsx | 科技前沿 | AI推荐列表+一键生成 |\n| talent-index.tsx | 人才雷达 | 复用 talent-radar 表格 |\n| academic-mobility.tsx | 人才雷达 | 复用 talent-radar 卡片 |\n| research-tracking.tsx | 高校生态 | 复用 competitor-monitoring 时间线 |\n| personnel-talent.tsx | 高校生态 | 复用 network-intelligence-view 列表 |\n| finance.tsx | 院内管理 | 预算执行+异常检测+风险 |\n| student-affairs.tsx | 院内管理 | 学生指标+心理预警+成绩 |\n| invitation-eval.tsx | 智能日程 | 扩展自 schedule ROI评分 |\n| conflict-resolver.tsx | 智能日程 | 扩展自 schedule 冲突检测 |\n\n---\n\n## 验证方案\n\n1. `npm run build` — 确保无 TypeScript 编译错误\n2. `npm run lint` — 通过 ESLint 检查\n3. 启动开发服务器，逐一验证:\n   - 8个模块侧边栏导航正确显示+分组分割线\n   - 侧边栏收起/展开正常\n   - 每个模块的子页面Tab切换流畅\n   - 每个子页面内容只包含单一维度信息\n   - 首页8个快捷卡片正确跳转\n4. Playwright 浏览器可视化验证\nPYEOF)",
      "mcp__plugin_playwright_playwright__browser_navigate",
      "Bash(curl:*)",
      "mcp__plugin_playwright_playwright__browser_evaluate",
      "mcp__plugin_playwright_playwright__browser_take_screenshot",
      "mcp__plugin_playwright_playwright__browser_click",
      "mcp__plugin_playwright_playwright__browser_close",
      "Bash(python3 -c \"\nimport os, re\nfor root, dirs, files in os.walk\\(''components/modules''\\):\n    for f in files:\n        if f.endswith\\(''.tsx''\\):\n            path = os.path.join\\(root, f\\)\n            with open\\(path\\) as fh:\n                for i, line in enumerate\\(fh, 1\\):\n                    # Find lines with left/right double curly quotes inside JS strings\n                    if ''\\\\u201c'' in line or ''\\\\u201d'' in line:\n                        print\\(f''{path}:{i}: {line.rstrip\\(\\)[:120]}''\\)\n\")",
      "Bash(\"/Users/sunminghao/Desktop/My Projects/Dean-Agent/docs/钉钉集成可行性分析与实施方案.md\" << 'ENDOFFILE'\n# DeanAgent 集成钉钉应用 + 钉钉机器人 可行性分析与实施方案\n\n## Context\n\n当前 DeanAgent 是一个纯前端 Next.js 16 应用，所有数据来自 mock 文件，没有后端 API、没有数据库、没有用户认证。用户希望将系统集成到钉钉生态中，实现：\n1. 院长在系统中查看院内外信息\n2. 院长指派任务 → 同步到钉钉机器人 → 机器人自动找到对应人通知\n3. 机器人定时扫描各部门知识库 → 更新项目和科研成果数据\n\n---\n\n## 结论：整体可行，但有多个关键难点需要逐一攻克\n\n这套方案**技术上完全可行**，钉钉开放平台提供了所需的全部 API 能力。但难度不在于「能不能做」，而在于「做好需要解决的工程问题」。下面逐一分析。\n\n---\n\n## 一、架构总览\n\n```\n┌─────────────────────────────────────────────────────────┐\n│                    钉钉客户端                              │\n│  ┌──────────────┐    ┌──────────────┐                    │\n│  │  H5 微应用    │    │  钉钉机器人   │                    │\n│  │ \\(DeanAgent\\)  │    │  \\(推送/交互\\)  │                    │\n│  └──────┬───────┘    └──────┬───────┘                    │\n└─────────┼───────────────────┼────────────────────────────┘\n          │                   │\n          ▼                   ▼\n┌─────────────────────────────────────────────────────────┐\n│              Next.js 后端 \\(API Routes\\)                    │\n│  ┌────────────┐ ┌────────────┐ ┌─────────────────────┐  │\n│  │ 钉钉Auth   │ │ 任务服务    │ │ 知识库同步服务        │  │\n│  │ \\(免登/鉴权\\) │ │ \\(CRUD/派发\\) │ │ \\(定时扫描/数据处理\\)   │  │\n│  └────────────┘ └────────────┘ └─────────────────────┘  │\n│  ┌────────────┐ ┌────────────┐ ┌─────────────────────┐  │\n│  │ 机器人消息   │ │ 通讯录服务  │ │ 数据聚合服务         │  │\n│  │ \\(推送/回调\\)  │ │ \\(部门/人员\\) │ │ \\(外部情报/内部数据\\)   │  │\n│  └────────────┘ └────────────┘ └─────────────────────┘  │\n└─────────────────────┬───────────────────────────────────┘\n                      │\n                      ▼\n              ┌───────────────┐\n              │   数据库       │\n              │ \\(PostgreSQL\\)  │\n              └───────────────┘\n```\n\n---\n\n## 二、需要集成的钉钉 API 能力清单\n\n| 能力 | 用途 | 钉钉API | 难度 |\n|------|------|---------|------|\n| **H5微应用免登** | 用户打开系统自动识别身份 | `dd.runtime.permission.requestAuthCode` | 低 |\n| **JSAPI鉴权** | 调用钉钉客户端能力 | `dd.config` + 服务端签名 | 中 |\n| **通讯录** | 获取部门/人员信息，用于任务指派 | `/v1.0/contact/users` | 低 |\n| **待办任务** | 院长指派任务 → 创建钉钉待办 | `/v1.0/todo/users/{unionid}/tasks` | 中 |\n| **机器人消息推送** | 主动通知指定人员 | 单聊: `/v1.0/robot/oToMessages/batchSend` | 中 |\n| **机器人交互** | 接收用户回复和指令 | Stream模式/HTTP回调 | 中 |\n| **知识库读取** | 扫描部门知识库内容 | 获取知识库API + 钉盘API | **高** |\n| **事件订阅** | 监听任务状态变更等 | 事件订阅机制 | 中 |\n\n---\n\n## 三、六大核心难点深度分析\n\n### 难点1: 从纯前端到全栈 — 后端架构从零构建\n\n**现状**: 当前项目没有任何后端，所有数据来自 `lib/mock-data/`。\n\n**需要构建的后端能力**:\n- Next.js API Routes \\(`app/api/`\\) 作为 BFF 层\n- 数据库 \\(PostgreSQL + Prisma ORM\\)\n- 钉钉 AccessToken 管理 \\(有效期2小时，需缓存刷新\\)\n- 定时任务调度器 \\(用于知识库扫描、数据聚合\\)\n- 消息队列 \\(可选，用于异步任务处理\\)\n\n**方案**: 利用 Next.js 自带的 Route Handlers 构建 API 层，避免引入额外的后端框架。数据库使用 PostgreSQL + Prisma。定时任务可通过外部 cron 服务 \\(如 Vercel Cron / 自建 node-cron\\) 触发。\n\n### 难点2: 钉钉免登与身份打通\n\n**挑战**: Next.js 默认是 SSR/SSG 应用，钉钉 JSAPI 依赖浏览器环境 \\(`window` 对象\\)。\n\n**免登流程**:\n```\n钉钉客户端打开H5 → 前端调用 dd.requestAuthCode 获取 code\n→ code 发送到我们的 API Route → API Route 用 code + AccessToken 换取 userId\n→ 返回自己系统的 session/JWT → 完成登录\n```\n\n**关键注意点**:\n- `dingtalk-jsapi` 必须在客户端动态导入 \\(`next/dynamic` 或 `useEffect` 内\\)\n- URL 签名必须与当前页面 URL 严格一致（Next.js pathname 路由不受 # 号影响，这是优势）\n- jsapi_ticket 有效期 7200 秒，需服务端缓存\n\n### 难点3: 「自动找到对应的人」— 智能任务路由\n\n**这是整个方案中最难的部分。**\n\n院长指派任务时，可能说的是\"让科研部跟进这个课题\"或\"通知张三处理\"。要实现「自动找到对应的人」需要：\n\n**方案A — 结构化指派 \\(推荐先行\\)**:\n- 利用钉钉通讯录 API 获取组织架构 \\(部门树 + 人员列表\\)\n- 在系统中构建「部门 → 负责人」映射表\n- 院长指派时通过选择器指定：部门/人员 + 任务类型\n- 系统根据映射自动定位到具体执行人\n\n**方案B — AI 语义理解 \\(进阶\\)**:\n- 接入 LLM 解析院长的自然语言指令\n- 结合组织架构数据做实体识别 \\(人名、部门名、职务\\)\n- 需要维护人员职责画像数据\n\n**建议**: 先实现方案A（结构化选择），后续迭代方案B。\n\n**钉钉待办任务创建参数**:\n```typescript\n// POST /v1.0/todo/users/{creatorUnionId}/tasks\n{\n  subject: \"跟进XX课题进展\",        // 任务标题\n  description: \"院长批示: ...\",     // 任务描述\n  executorIds: [\"user_union_id\"],  // 执行人\n  participantIds: [\"...\"],         // 参与人\n  dueTime: 1700000000000,         // 截止时间\n  priority: 30,                    // 紧急程度 \\(10/20/30/40\\)\n  detailUrl: {\n    appUrl: \"https://your-app/task/123\",  // 移动端详情页\n    pcUrl: \"https://your-app/task/123\"    // PC端详情页\n  }\n}\n```\n\n### 难点4: 知识库定时扫描与数据提取\n\n**挑战**: 钉钉知识库 API 的开放程度有限，且数据格式多样。\n\n**钉钉提供的知识库相关能力**:\n- 获取知识库列表 API\n- 钉盘文件读取 API\n- 文档空间 API\n\n**难点在于**:\n1. **数据格式差异**: 知识库中可能有文档、表格、图片、PDF 等多种格式，解析逻辑复杂\n2. **增量同步**: 需要识别哪些内容是新增/更新的，避免全量扫描\n3. **内容理解**: 从原始文档中提取「项目进展」「科研成果」等结构化信息，需要 NLP/LLM\n4. **权限控制**: 不同部门的知识库可能有不同访问权限\n\n**方案**:\n```\n定时任务 \\(每日/每周\\)\n  → 调用知识库 API 获取各部门文档列表\n  → 对比上次扫描记录，识别增量\n  → 下载/读取新增文档内容\n  → 调用 LLM 提取关键信息 \\(项目名、进展、成果、负责人\\)\n  → 存入数据库，更新系统内的「内部管理」模块数据\n  → 生成变更摘要，通过机器人推送给院长\n```\n\n**替代方案**: 使用钉钉 AI 助理的知识库集成能力，让钉钉 AI 助理直接关联各部门知识库，通过 AI 助理的 API 来获取结构化信息，降低自建解析逻辑的复杂度。\n\n### 难点5: 机器人消息设计与交互\n\n**消息类型选择**:\n| 场景 | 推荐消息类型 | 原因 |\n|------|-------------|------|\n| 任务通知 | 互动卡片 \\(ActionCard\\) | 支持按钮操作（接受/拒绝/查看详情）|\n| 日报推送 | Markdown 消息 | 格式丰富，阅读体验好 |\n| 紧急告警 | 文本 + @指定人 | 直接醒目 |\n| 进度汇报 | 互动卡片 | 支持展开详情和操作按钮 |\n\n**限制与注意**:\n- 单聊机器人: 20条消息/分钟\n- 批量发送需控制频率，避免触发限流\n- Stream 模式支持流式输出 \\(适合 AI 对话场景\\)\n\n### 难点6: 数据一致性与同步\n\n**双向同步问题**:\n- 院长在系统中创建任务 → 需同步到钉钉待办\n- 执行人在钉钉中完成任务 → 需回调更新系统状态\n- 知识库更新 → 需触发系统数据刷新\n\n**方案**: 使用钉钉事件订阅机制，监听待办状态变更事件，通过 webhook 回调更新系统数据库。\n\n---\n\n## 四、分阶段实施路线\n\n### Phase 1: 基础集成 \\(搭建后端 + 钉钉接入\\)\n**目标**: 让系统能在钉钉内运行，实现身份打通\n\n需要修改/新增的文件:\n- `app/api/dingtalk/auth/route.ts` — 免登认证\n- `app/api/dingtalk/config/route.ts` — JSAPI 鉴权签名\n- `lib/services/dingtalk/token.ts` — AccessToken 管理\n- `lib/services/dingtalk/crypto.ts` — 签名计算\n- `middleware.ts` — 身份验证中间件\n- 安装 `dingtalk-jsapi`, `@alicloud/dingtalk` SDK\n\n### Phase 2: 任务系统 \\(指派 + 通知\\)\n**目标**: 院长能指派任务，机器人自动通知对应人员\n\n需要修改/新增的文件:\n- `app/api/tasks/route.ts` — 任务 CRUD\n- `app/api/dingtalk/robot/route.ts` — 机器人消息发送\n- `app/api/dingtalk/contacts/route.ts` — 通讯录查询\n- `lib/services/dingtalk/todo.ts` — 待办任务服务\n- `lib/services/dingtalk/robot.ts` — 机器人消息服务\n- `lib/services/dingtalk/contacts.ts` — 通讯录服务\n- `components/modules/*/` — 改造现有页面，添加任务指派UI\n- 数据库 schema: tasks, users, departments 表\n\n### Phase 3: 知识库同步\n**目标**: 定时扫描知识库，自动更新系统数据\n\n需要修改/新增的文件:\n- `app/api/sync/knowledge-base/route.ts` — 知识库同步触发\n- `lib/services/dingtalk/knowledge.ts` — 知识库 API 封装\n- `lib/services/sync/scanner.ts` — 增量扫描逻辑\n- `lib/services/sync/parser.ts` — 文档内容解析\n- Cron job 配置\n\n### Phase 4: 智能化增强\n**目标**: AI 辅助任务路由、自然语言指令、智能摘要\n\n---\n\n## 五、技术依赖与环境要求\n\n| 依赖 | 说明 |\n|------|------|\n| 钉钉企业管理员权限 | 需要在钉钉开放平台创建企业内部应用 |\n| 钉钉开放平台 AppKey/AppSecret | 应用身份凭证 |\n| 服务器 \\(带公网IP/域名\\) | 钉钉回调需要公网可达的 HTTPS 地址 |\n| PostgreSQL 数据库 | 存储任务、用户映射、同步记录等 |\n| HTTPS 证书 | 钉钉要求所有接口使用 HTTPS |\n| \\(可选\\) Redis | 缓存 AccessToken、jsapi_ticket |\n\n---\n\n## 六、风险与建议\n\n| 风险 | 影响 | 缓解措施 |\n|------|------|---------|\n| 知识库 API 开放程度不足 | 可能无法读取所有格式的文档内容 | 先调研 API 实际返回数据，必要时使用钉钉 AI 助理作为中间层 |\n| 钉钉接口限流 \\(6000次/20秒\\) | 大批量操作可能被限制 | 实现请求队列和重试机制 |\n| 免登在非钉钉环境不可用 | 开发调试困难 | 实现双模式: 钉钉环境用免登，浏览器环境用账密登录 |\n| 组织架构变动 | 人员映射表过期 | 定期同步通讯录 + 事件订阅监听变更 |\n| 文档格式多样性 | 解析质量参差不齐 | 先支持主流格式\\(文档/Markdown\\)，逐步扩展 |\n\n---\n\n## 七、验证方式\n\n1. **H5微应用**: 在钉钉开发者后台创建测试应用，使用内网穿透工具 \\(如 ngrok\\) 将本地开发服务器暴露给钉钉\n2. **机器人**: 先创建测试群，添加自定义机器人，验证消息推送\n3. **待办任务**: 调用 API 创建测试待办，确认出现在钉钉客户端\n4. **知识库**: 先用 API Explorer 测试知识库接口返回数据格式\n\n---\n\n## 参考资料\n\n- [钉钉开放平台]\\(https://open.dingtalk.com/\\)\n- [钉钉开发文档]\\(https://open.dingtalk.com/document/\\)\n- [钉钉 API Explorer]\\(https://open-dev.dingtalk.com/apiExplorer\\)\n- [钉钉 API 总览]\\(https://open.dingtalk.com/document/development/api-overview\\)\n- [创建钉钉待办任务]\\(https://open.dingtalk.com/document/development/add-dingtalk-to-do-task\\)\n- [获取知识库 API]\\(https://open.dingtalk.com/document/development/obtain-the-knowledge-base\\)\n- [钉钉 H5 微应用开发]\\(https://www.cnblogs.com/zhenjingcool/p/16896396.html\\)\n- [钉钉 JSAPI 鉴权]\\(https://blog.csdn.net/KLS_CSDN/article/details/144795171\\)\n- [钉钉 GitHub 开源项目]\\(https://github.com/open-dingtalk/\\)\n- [阿里云百炼 + 钉钉 AI 机器人]\\(https://help.aliyun.com/zh/model-studio/add-an-ai-assistant-to-your-dingtalk-in-10-minutes\\)\n- [钉钉 IM 开放平台]\\(https://imopen.dingtalk.com/\\)\nENDOFFILE)",
      "mcp__plugin_playwright_playwright__browser_snapshot",
      "mcp__plugin_playwright_playwright__browser_press_key",
      "mcp__plugin_playwright_playwright__browser_resize",
      "mcp__plugin_playwright_playwright__browser_type"
    ],
    "additionalDirectories": [
      "/tmp"
    ]
  },
  "enableAllProjectMcpServers": true,
  "enabledMcpjsonServers": [
    "postgresql"
  ],
  "enabledPlugins": {
    "code-simplifier@claude-plugins-official": true
  }
}
